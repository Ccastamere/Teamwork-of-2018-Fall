# Sigma***## 简介Sigma 是阿里巴巴全集团范围的 Pouch 容器调度系统。2017年是 Sigma 正式上线以来第1次参与双11，在双11期间成功支撑了全集团所有容器（交易线中间件、数据库、广告等20多个业务）的调配，使双11IT成本降低50%，是阿⾥巴巴运维系统重要的底层基础设施。Sigma 已经是阿里全网所有机房在线服务管控的核心角色，管控的宿主机资源达到几十万量级，重要程度不言而喻，其算法的优劣程度影响了集团整体的业务稳定性，资源利用率。## 特征### 统一调度系统* Sigma 有 Alikenel、SigmaSlave、SigmaMaster 三层大脑联动协作，Alikenel 部署在每一台物理机上，对内核进行增强，在资源分配、时间片分配上进行灵活的按优先级和策略调整，对任务的时延，任务时间片的抢占、不合理抢占的驱逐都能通过上层的规则配置自行决策。SigmaSlave 可以在本机进行容器 CPU 分配、应急场景处理等。通过本机 Slave 对时延敏感任务的干扰快速做出决策和响应，避免因全局决策处理时间长带来的业务损失。SigmaMaster 是一个最强的中心大脑，可以统揽全局，为大量物理机的容器部署进行资源调度分配和算法优化决策。* 整个架构是面向终态的设计理念，收到请求后把数据存储到持久化存储层，调度器识别调度需求分配资源位置，Slave识别状态变化推进本地分配部署。系统整体的协调性和最终一致性非常好。### 混部架构* 在线服务属于长生命周期、规则策略复杂性高、时延敏感类任务。而计算任务生命周期短、调度要求大并发高吞吐、任务有不同的优先级、对时延不敏感。基于这两种调度的本质诉求的不同，在混合部署的架构上把两种调度并行处理，即一台物理机上可以既有 Sigma 调度又有 Fuxi 调度，实现基础环境统一。* Sigma 调度是通过 SigmaAgent 启动 PouchContainer 容器。Fuxi 也在这台物理机上抢占资源，启动自己的计算任务。所有在线任务都在 PouchContainer 容器上，它负责把服务器资源进行分配并运行在线任务，离线任务填入其空白区，保证物理机资源利用达到饱和，这样就完成了两种任务的混合部署。### 云化架构* 将集群分为在线任务集群、计算任务集群和 ECS 集群。资源管理，单机运维、状况管理，命令通道、监控报警这类基础运维体系已经打通。在双 11 场景中，在云上划出一个独立的区域与其他场景互通。在互通区域，Sigma 调度可以到计算集群服务器里申请资源，生产 Pouch 容器，也可以到 cloud open API 去申请 ECS，生产出容器的资源。在日常的场景中 Fuxi 可以到 sigma 里申请资源，创建需要的容器。## 优缺点### 优点#### 内核资源隔离* 在 CPU HT 资源隔离上，做了 Noise Clean 内核特性，解决在 / 离线超线程资源争抢问题。* 在 CPU 调度隔离上，CFS 基础上增加 Task Preempt 特性，提高在线任务调度优先级。* 在 CPU 缓存隔离上，通过 CAT，实现在、离线三级缓存 (LLC) 通道隔离 (Broadwell 及以上)。* 在内存隔离上，拥有 CGroup 隔离 /OOM 优先级；Bandwidth Control 减少离线配额实现带宽隔离。* 在内存弹性上，在内存不增加的情况下，提高混部效果，在线闲置时离线突破 memcg limit；需要内存时，离线及时释放。* 在网络 QoS 隔离上，管控打标为金牌、在线打标为银牌、离线打标为铜牌，分级保障带宽。#### 在线集群管理* 对应用的内存、CPU、网络、磁盘和网络 I/O 容量进行画像，知道它的特征、资源规格需求，不同的时间对资源真实使用情况，然后对整体规格和时间进行相关性分析，进行整体调度优化。* 亲和互斥和任务优先级的分配，哪种应用放在一起使整体计算能力比较少、吞吐能力比较高，这是存在一定亲和性。* 不同的场景有不同的策略，双 11 的策略是稳定优先，稳定性优先代表采用平铺策略，把所有的资源用尽，让资源层全部达到最低水位。日常场景需要利用率优先，“利用率优先” 指让已经用掉的资源达到最高水位，空出大量完整资源做规模化的计算。* 应用做到自动收缩、垂直伸缩、分时复用。* 整个站点的快速扩容缩容，弹性内存技术等。#### 采用PouchContainer 容器* 结合了阿里内核，大幅度提高了安全隔离性，目前以百万级规模部署于阿里集团内部。* 隔离性非常好，是富容器，可以运行很多的进程。* 兼容性很好， 旧版本内核也支持，对利旧很有帮助。### 缺点* 规模问题：各T4分组规模不一，大部分都是小规模，导致规模碎片化。* 调度问题：T4分组内小规模调度，核心应用打散受限。* 资源分配：双11期间交易相关CPU充分售卖，无空闲CPU，而众多T4分组，宿主机尚未分配容器实例。* 资源利用率不均衡：部分分组CPU满负载运行（45%-50%），而相当多分组CPU却几乎完全空闲。## 评价Sigma在双11期间的表现已经证明了它作为一个容器系统的优秀之处。但即便如此，也不能停下不断改良，精益求精的脚步。在资源方面，可以促进混合云架构进一步发展，混合云深度联动，实时共享资源，并通过大规模混部、优先级差异化提升资源使用效率。在调度方面，更好的感知应用的SLA需求、减少应用间干扰。同时还可以改进适应异构计算需求，为异构计算优化。唯有如此，Sigma才能帮助阿里巴巴全面实现业务容器化，打好集团“云化”战略坚实的基础。